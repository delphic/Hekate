<html>
	<head>
		<meta charset="utf-8">
		<title>Hekate</title>
		<!-- meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';" /-->
		<!-- Consistently get refused to create worker error in console because of CSP, 
		    even when worker-src is specified and you put *, or blob:* and/or filesystem:*
		    so at a bit of a loss how to solve that, so comment out again for now
		-->
		<style>
html { padding: 0; margin: 0; }
body { padding: 0; margin: 0; background: #EEE; color: #111; font-family: monospace; overflow-y: hidden; }
#editor { height: calc(100% - 60px); }
/* TODO use https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Grid_Layout */
/* Consider fr units https://css-tricks.com/introduction-fr-css-unit/ */ 
fieldset { height: 30px; padding: 0 5px; margin: 0; border: none; }
fieldset p { display:inline-block; margin-top: 9px; }
fieldset #fileMode { float: right; }
fieldset div { margin: 5px 0; }
fieldset input, fieldset select { width: 100px; }
fieldset input.button { width: auto; margin: 5px 0; }
		</style>
<!-- Would be nice to be able to reuse the ace themes on the rest of the UI -->
	</head>
	<body onkeypress="onKeyPress(event);">
		<fieldset id="controls">
			<input type="button" class="button" value="Open" onclick="openDialog();" />
			<input type="button" class="button" value="Save" onclick="saveFile();" />
		</fieldset>
		<div id="editor"></div>
		<fieldset id="bottomBar">
		    <p id="logMessage"></p>
		    <p id="fileMode">Plain Text</p>
		</fieldset>
		<script src="libs/ace/ace.js" type="text/javascript" charset="utf-8"></script>
		<script>
// TODO: General ace settings - ideally on change intercept, failing that use onbeforeunload
// ideally would save ace settings directly into config, rather than hand coding a shim

// TODO: Tabs and New files

// TODO: Would be kinda nice to be able to load ace and electron documentation inside this editor
// Would also be nice to have markdown / HTML preview windows - feels like if we can render arbitary 
// pages in tabs we can easily build an editor - should we be using the main program to control this?
// It would be nice to be able to have deattachable separate windows, and the ability to merge and split.

const { app, dialog } = require('electron').remote;
const currentWindow = require('electron').remote.getCurrentWindow();

var fs = require('fs');

var config;
var lastOpenedFilePath = "";
var currentFilePath = "";
var configPath = app.getPath('userData') + "/config.json";

var editor = ace.edit("editor");

/* Config  */
var loadConfig = function() {
	try {
		config = JSON.parse(fs.readFileSync(configPath, "utf-8"));
	} catch (error) {
		// Pokemon - file doesn't exist
	    config = { 
	        lastOpenedFilePath: "",
	        aceThemePath: "ace/theme/monokai",
	    };
	}
}

var getAceTheme = function() {
    if (config && config.hasOwnProperty("aceThemePath")) {
		return config["aceThemePath"];
	}
	return "ace/theme/monokai"; // Obviously the best default theme
};

var setAceTheme = function(themePath) {
    if (!config.hasOwnProperty("aceThemePath") || config.aceThemePath != themePath) {
        config["aceThemePath"] = themePath;
        saveConfig();
    }
};

var getLastOpenedFilePath = function() {
	if (config && config.hasOwnProperty("lastOpenedFilePath")) {
		return config["lastOpenedFilePath"];
	}
	return null;
};

var setLastOpenedFilePath = function(path) {
    if (!config.hasOwnProperty("lastOpenedFilePath") || config.lastOpenedFilePath != path) {
        config["lastOpenedFilePath"] = path;
        saveConfig();
    }
};

var saveConfig = function() {
   	fs.writeFile(configPath, JSON.stringify(config), function(error) { });
};


/* Utils */
var removeAllChildNodes = function(element) {
  while (element && element.firstChild) {
      element.removeChild(element.firstChild);
  } 
};

var getFileNamesInDir = function(path) {
	let files = fs.opendirSync(path, "utf-8");
	let file = files.readSync();

	let fileNames = [];
	while (file && file.isFile()) {
		fileNames.push(file.name);
		file = files.readSync();
	}
	return fileNames;
};

var getFileExtension = function(filePath) {
    // https://stackoverflow.com/questions/190852/how-can-i-get-file-extensions-with-javascript/12900504#12900504
    return filePath.slice((filePath.lastIndexOf(".") - 1 >>> 0) + 2);  
};

var getFileName = function(filePath) {
    return filePath.slice(filePath.lastIndexOf("/") + 1);
};

var getPath = function(filePath) {
    return filePath.slice(0, filePath.lastIndexOf("/"));
};

var getUserDocumentsPath = function() {
    return "/home/pi/Documents/"; // TODO: Don't hardcode this!
};

/* Editor Display Updates */
var logMessage = function(message) {
    // TODO: should probably escape this
    document.getElementById("logMessage").innerHTML = message;
    // Clear after timeout?
};

var logError = function(error) {
    document.getElementById("logMessage").innerHTML = "<span style='color:red'>" + error.message + "</span>";
    console.log(JSON.stringify(error));
};

var updateFileModeDisplay = function(fileMode) {
    document.getElementById("fileMode").innerHTML = fileMode;
};

/* File Save / Load */ 
var openDialog = function() {
    // https://www.electronjs.org/docs/api/dialog
	let files = dialog.showOpenDialogSync(currentWindow, {
		title: "Open File",
		defaultPath: currentFilePath ? getPath(currentFilePath) : getUserDocumentsPath(),
		properties: [ "openFile" ]
	});
	if (files && files[0]) {
	    loadFile(files[0]);
	    // Arguably this should be in a callback and we should move the logic to config class
	    setLastOpenedFilePath(files[0])
	}
};

var loadFile = function(filePath) {
	// TODO: check for unsaved changes (store original value on loading, compare)
	// also sub to event for editor content changed and mark as changed
	if (filePath) {
		fs.readFile(filePath, 'utf-8', function(error, data) {
			if (!error) {
				editor.setValue(data);
				editor.selection.clearSelection();
				editor.selection.moveCursorTo(0, 0, false);
				currentFilePath = filePath;
				let extension = getFileExtension(filePath);
				switch(extension)
				{
				    case "js":
				        editor.session.setMode("ace/mode/javascript");
				        updateFileModeDisplay("JavaScript");
				        break;
			        case "json":
			            editor.session.setMode("ace/mode/json");
			            updateFileModeDisplay("JSON");
			            break;
				    case "htm":
			        case "html":
				        editor.session.setMode("ace/mode/html");
				        updateFileModeDisplay("HTML");
			            break;
			        case "glsl":
				        editor.session.setMode("ace/mode/glsl");
				        updateFileModeDisplay("GLSL");
				        break;
				    case "markdown":
				    case "md":
				        editor.session.setMode("ace/mode/markdown");
				        updateFileModeDisplay("Markdown");
				        break;
				    default:
				        editor.session.setMode("ace/mode/text");
				        updateFileModeDisplay("Plain Text");
    				    break;
				}
				// TODO: Watch file and notify of external changes
				logMessage("Loaded " + filePath);
			} else {
				logError(error);
			}
		});
	}
};

var saveFile = function() {
	let filePath = currentFilePath;
	if (!filePath) {
	    filePath = dialog.showSaveDialogSync(currentWindow, { 
	        title: "Save As...",
	        properties: [ "createDirectory" ]
	    });
	    currentFilePath = filePath;
	}
	
	if (filePath) {
		fs.writeFile(filePath, editor.getValue(), function(error) { 
			if (!error) {
				logMessage("Saved " + filePath); 
				// TODO: Issue events or use a callback
			} else {
				logError(error);
			}
		});
	}
};

var deleteFile = function(filePath) {
	if (filePath && window.confirm("Are you sure?")) {
		// TODO: Consider Undo over confirm https://alistapart.com/article/neveruseawarning/
		fs.unlink(filePath, function(error) {
			if (error) {
				logError(error);
			} else {
				logMessage("Deleted " + filePath);
			}
		});
	}
};

// Set Hotkeys
var onKeyPress = function(event) {
    if (event.ctrlKey) {
        switch(event.key)
        {
            case "s":
                saveFile();
                break;
            case "o":
                openDialog();
                break;
        }
    }
};

// Unload Management
window.addEventListener('beforeunload', function(event) {
    // TODO: Check for unsaved changes and prompt if there are before closing
    /* 
    // To prevent unloading...
    event.preventDefault(); // This is as per spec
    event.returnValue = ''; // This is required by Chrome
    */
    setAceTheme(editor.getTheme());
});

// Start-up logic
loadConfig();
editor.setTheme(getAceTheme());
lastOpenedFilePath = getLastOpenedFilePath();
if (lastOpenedFilePath) {
	loadFile(lastOpenedFilePath);
}
		</script>
		<!--
		<p>Version Info:</p>
		<ul>
			<li>node <script>document.write(process.versions.node)</script></li>
			<li>chrome <script>document.write(process.versions.chrome)</script></li>
			<li>electron <script>document.write(process.versions.electron)</script></li>
		</ul>
		-->
	</body>
</html>