<html>
	<head>
		<meta charset="utf-8">
		<title>Hekate</title>
		<!-- https://www.electronjs.org/docs/tutorial/security#6-define-a-content-security-policy -->
		<!-- https://electronjs.org/docs/tutorial/security#csp-meta-tag -->
		<!--meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';" /-->
		<style>
html { padding: 0; margin: 0; }
body { padding: 0; margin: 0; background: #EEE; color: #111; font-family: monospace; }
#editor { height: 90%; } /* Oh no the classic height problems of css */
fieldset { position: relative; }
fieldset div { margin: 5px 0; }
fieldset input, fieldset select { width: 100px; }
fieldset input.button { width: auto; margin: 5px 0; }
		</style>
<!-- Would be nice to be able to reuse the ace themes on the rest of the UI -->
	</head>
	<body>
		<fieldset id="controls">
			<input type="button" class="button" value="Open" onclick="openDialog();" />
			<input type="button" class="button" value="Save" onclick="saveFile();" />
		</fieldset>
		<div id="editor"></div>
		<script src="libs/ace/ace.js" type="text/javascript" charset="utf-8"></script>
		<script>

// TODO: Would be kinda nice to be able to load ace and electron documentation inside this editor
// TODO: Hotkeys
// TODO: Show current file type in bottom right, with a popup to change it.
// TODO: Show log messages in bottom bar (e.g. confirmed save, confirmed load etc)

const { dialog } = require('electron').remote;
// https://www.electronjs.org/docs/api/dialog
const currentWindow = require('electron').remote.getCurrentWindow();

var currentFilePath = "";
var fs = require('fs');
var editor = ace.edit("editor");
editor.setTheme("ace/theme/monokai");

var openDialog = function() {
	let files = dialog.showOpenDialogSync(currentWindow, {
		title: "Open File",
		defaultPath: "/home/pi/",
		properties: [ "openFile" ]
	});
	if (files) {
	    loadFile(files[0]);
	}
};

var refreshFileSelect = function() {
	let files = fs.opendirSync("files", "utf-8");
	let file = files.readSync();
	let fileNameSelect = document.getElementById("loadFileName");
	
	while (fileNameSelect.firstChild) {
		fileNameSelect.removeChild(fileNameSelect.firstChild);
	}
	
	// TODO: Append empty child for when first loading?
	let fileNames = [];
	while (fileNameSelect && file && file.isFile()) {
		fileNames.push(file.name);
		file = files.readSync();
	}
	let l = fileNames.length; 
	while (l > 0) {
		l -= 1;
		fileNameSelect.appendChild(document.createElement("option")).innerHTML = fileNames[l];
	}
};

var getFileExtension = function(path) {
    // https://stackoverflow.com/questions/190852/how-can-i-get-file-extensions-with-javascript/12900504#12900504
    return path.slice((path.lastIndexOf(".") - 1 >>> 0) + 2);  
};

var loadFile = function(path) {
	// TODO: check for unsaved changes
	if (path) {
		fs.readFile(path, 'utf-8', function(error, data) {
			if (!error) {
				editor.setValue(data);
				editor.selection.clearSelection();
				editor.selection.moveCursorTo(0, 0, false);
				currentFilePath = path;
				let extension = getFileExtension(path);
				switch(extension)
				{
				    case "js":
				        editor.session.setMode("ace/mode/javascript");
				        break;
			        case "json":
			            editor.session.setMode("ace/mode/json");
			            break;
				    case "htm":
			        case "html":
				        editor.session.setMode("ace/mode/html");
			            break;
			        case "glsl":
				        editor.session.setMode("ace/mode/glsl");
				        break;
				    case "markdown":
				    case "md":
				        editor.session.setMode("ace/mode/markdown");
				        break;
				    default:
				        editor.session.setMode("ace/mode/text");
    				    break;
				}
				
				// TODO: Better tracking of loaded file than value of saveFileName
				console.log("Loaded " + path + "!");
			} else {
				console.log(JSON.stringify(error));
			}
		});
	}
};

var deleteFile = function() {
	let fileName = document.getElementById("loadFileName").value;
	if (fileName && window.confirm("Are you sure?")) {
		// TODO: Consider Undo over confirm https://alistapart.com/article/neveruseawarning/
		fs.unlink('files/' + fileName, function(error) {
			if (error) {
				console.log(JSON.stringify(error));
			} else {
				let saveFileNameElement = document.getElementById("saveFileName");
				if (saveFileNameElement.value == fileName) {
					saveFileNameElement.value = "";
					editor.setValue("");
				}
				refreshFileSelect();
				console.log("Deleted " + fileName + "!");
			}
		});
	}
};

var saveFile = function() {
	let fileName = currentFilePath;
	if (!fileName) {
	    fileName = dialog.showSaveDialogSync(currentWindow, { 
	        title: "Save As...",
	        properties: [ "createDirectory" ]
	    });
	}
	
	if (fileName) {
		fs.writeFile(fileName, editor.getValue(), function(error) { 
			if (!error) {
				console.log("Saved " + fileName + "!"); 
				// TODO: Issue events for things which care instead of manually doing this
				//refreshFileSelect();
				// document.getElementById("loadFileName").value = fileName;
			} else {
				console.log(JSON.stringify(error));
			}
		});
	}
};
		</script>
		<!--
		<p>Version Info:</p>
		<ul>
			<li>node <script>document.write(process.versions.node)</script></li>
			<li>chrome <script>document.write(process.versions.chrome)</script></li>
			<li>electron <script>document.write(process.versions.electron)</script></li>
		</ul>
		-->
	</body>
</html>